<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>I-Seed drone&#39;s onboard service: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">I-Seed drone&#39;s onboard service
   &#160;<span id="projectnumber">0.0.9</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="contents">
<div class="textblock"><h1><a class="anchor" id="communication_protocol"></a>
Communication protocol</h1>
<p>When the onboard service is <a class="el" href="classdrone.html#af1f1e7a230a184ecd3747f80c9692940">started</a>, it listens for the commands from a user. The figure below shows how the I-Seed Drone Control Android application communicates with the I-Seed onboard service. The Android application runs on an Android phone connected to the droneâ€™s remote control via a USB cable. The commands are noted in uppercase. If extra parameters for a command are needed, they are sent/received as the follow-up message with data.</p>
<div class="image">
<img src="protocol.jpg" alt=""/>
</div>
<p>When a connection is established between the application and the drone, the application will send the <b>PING</b> command and will wait for a reply with the <b>PONG</b> command back. This one needed to verify that communication is actually working because the API peculiarity is that all the interconnections return successful codes, but the real packets will start receiving later.</p>
<p>There is a service running in a background thread on the drone that periodically sends the current mission states and its geographical coordinates. The drone service sends a <b>DRONE_INFO</b> command to inform the Android app that a coordinate data and mission state message will follow. The <code>mission_path</code> message with the coordinates of the mission path built from the user input polygon will be sent in case of the special drone state called <code>PATH_DATA</code>.</p>
<p>When the drone operator is ready, a mission can be started via the Android application interface. The first step will be to build and approve the mission path by providing an input polygon and sending the <b>BUILD_MISSION</b> command. Coordinates will be taken from the Google Map widget of the Android app. In the second step, user sends a <b>MISSION_START</b> command to the drone service and actually starts the mission. If the mission path doesn't look appropriate for any reason, the user can clear the mission path by sending <b>MISSION_PATH_CANCEL</b> and tweak the input polygon.</p>
<p>During a mission, a drone operator can pause, resume, or abort its execution. This is achieved by sending <b>MISSION_PAUSE</b>, <b>MISSION_CONTINUE</b>, and <b>MISSION_ABORT</b> commands, respectively, to the drone service.</p>
<p>Since the effect of applying mission control command is not immediate, and there is a pool of send/received messages, the <code>event_id</code> counter is introduced to synchronize the state. After each user's mission command, such as <b>MISSION_PAUSE</b> or <b>MISSION_CONTINUE</b>, the <code>event_id</code> counter increased by one. All the mission states received in DRONE_INFO with the less value in <code>event_id</code> will be ignored until the message with updated <code>event_id</code> is received.</p>
<p>The full mission consists of a forward mission (when we take photos and run inference in the background) and a backward mission (when we revisit waypoints where objects were detected and run laser measurements for each object). In both cases, when <a class="el" href="classmission.html#ad13add664939d029ea60fdd0483a9f59">a waypoint is reached</a>, the mission is paused, and custom code is run in the <code>action_job</code> thread. If a forward mission is finished, the mission type is <a class="el" href="classmission.html#a462d55cf83661f5b405d8ee9769b2cac">changed to backward</a>, and a similar cycle continues until ready.</p>
<p>If an I-Seed is detected in a waypoint during a forward mission, the range between the camera and the I-Seed needs to be known. For this, the DJI Zenmuse H20/T laser rangefinder is used in a waypoint during a backward mission. However, there is no API call for the <code><a class="el" href="classlaser__range.html" title="Information about the laser range measurement.">laser_range</a></code> data available from the Payload SDKs, one needs to use a hack to retrieve this information from the Mobile SDK. The onboard service emits a <b>LASER_RANGE_REQUEST</b> command to the Mobile SDK that runs with the Android app to achieve this. After that, the Mobile SDK sends <b>LASER_RANGE_RESPONSE</b> with the <code><a class="el" href="classlaser__range.html" title="Information about the laser range measurement.">laser_range</a></code> message back to the onboard service that uses this information to compute the geolocalisation of the I-Seed.</p>
<p>It's not possible to know beforehand the actual height of the drone above the ground. We only know the actual height after laser measurement of the place received. The <b>LASER_RANGE_REQUEST</b> command will be used in this case too. If the actual height is too low or too high, the mission waypoint's height has to be corrected.</p>
<h1><a class="anchor" id="control_app"></a>
I-Seed drone control</h1>
<p>There are a UI system thread that receives UI events and three custom threads: reading/writing from pipe (interconnection) and a polling job that checks the state. The <code>executeCommands</code> is a buffer with commands.</p>
<p>UI thread will process the events from the drone operator. E.g., if a user wants to abort the mission, command <code>MISSION_ABORT</code> put into a queue. When <code>writePipelineJob</code> takes control of the queue, it reads <code>MISSION_ABORT</code> and is responsible for sending it to a drone.</p>
<p>Read-from-pipe thread with the <code>readPipelineJob</code> method will process the commands received from the drone. When the <b>PONG</b> command is received, it means communication with a drone is established, and a drone is ready to accept other commands. <b>DRONE_INFO</b> command informs that coordinates with the mission state data are prepared. Drone coordinates are used for drawing drone icons in the Google Map widget. Mission state will be used to draw the controlling UI buttons. E.g., if a mission is stopped, UI is switched to the state when an operator can start a new mission. When <code>readPipelineJob</code> receives a <b>LASER_RANGE_REQUEST</b> request from the drone, it puts <b>LASER_RANGE_RESPONSE</b> into a queue. When <code>writePipelineJob</code> takes control of the queue, it reads <b>LASER_RANGE_RESPONSE</b> and sends it to the drone, but this time command is sent with the data - the value of laser range measurement.</p>
<p>The <code>pollJob</code> method is the main point of calling Mobile SDK API. It is responsible for initialization. It periodically checks the state of a connected smart controller, updates UI widgets, checks the pipeline, checks the GPS signal, enables laser, etc.</p>
<div class="image">
<img src="control.jpg" alt=""/>
</div>
<p>The following diagram describes the state of the drone control Android application. The initial state is <code>WAITING</code> since the drone may already be in the progress of mission execution (e.g., the application is restarted). In the <code>READY</code> state, the user can provide a mission input polygon. The cancel button will clear the polygon, and the action button will send the <b>BUILD_MISSION</b> command.</p>
<p>When the mission path is ready, the special state <code>PATH_DATA</code> will be received from the onboard service, and the <code>mission_path</code> message will be the next packet. After this state, the next state will be <code>PATH</code>. In the <code>PATH</code> state user can cancel the mission by sending <b>MISSION_PATH_CANCEL</b> or start the mission by sending <b>MISSION_START</b>. State <code>EXECUTING</code> is a normal state when a mission is in progress. State <code>PAUSED</code> received when a user pauses the mission. In both those states mission can be aborted by sending <b>MISSION_ABORT</b>.</p>
<div class="image">
<img src="states_control.jpg" alt=""/>
</div>
<dl class="section note"><dt>Note</dt><dd>Java, Android</dd></dl>
<h1><a class="anchor" id="onboard_service_threads"></a>
I-Seed onboard service</h1>
<p><a class="anchor" id="thread_psdk_callback"></a><a class="anchor" id="thread_inference"></a><a class="anchor" id="thread_receive_data"></a><a class="anchor" id="thread_user_control"></a><a class="anchor" id="thread_send_data"></a><a class="anchor" id="thread_action"></a> After the drone is started, there are six threads:</p><ul>
<li>Payload SDK callback thread, that's where asynchronous callbacks from Payload SDK live. E.g., we can receive an event that the mission is finished or the waypoint reached (see <a class="el" href="classmission.html">mission</a> and <a class="el" href="classmission__state.html">mission_state</a>). Note that there should be no time-consuming calls or blocks here. The callback should be finished as soon as possible</li>
<li><code>inference_job</code> checks for <a class="el" href="classcamera.html#a96c1e0428a06d3ab672018ce03a90118">new files on SDCard</a>, and if a new JPG file is found, it <a class="el" href="classinference.html#ace0e2a040196a21a09e76fe4dcd663cf">launches the inference</a> and <a class="el" href="classmission.html#a5fc4884cbe6cdc77cbc095c2bf3ab463">saves the result back</a> to the <a class="el" href="classwaypoint.html#a45c7cd14e4f8001817cfeb9c51657503">waypoint data</a></li>
<li><code>receive_data_job</code> is reading pipe. That's where commands and data (like <a class="el" href="classlaser__range.html#ab137b81a46e1079c1188f5105df77b5d">laser_range::value_received</a>) from the Android app come from</li>
<li><code>send_data_job</code> is writing commands to pipe, commands are read from <code>execute_commands_</code> queue, if needed extra data send as a follow-up</li>
<li><code>user_control_job</code> is waiting for the right conditions to execute <a class="el" href="classmission.html#a70c466fa378fa9c57c2d14af0b143348">mission::abort</a> and <a class="el" href="classmission.html#ae9a858ec70a1f8be295bf95e8ba8cdfd">mission::pause</a> requested by the user. Code moved from <code>receive_data_job</code> to avoid blocking the read pipe</li>
<li><code>action_job</code> is executed when we reach a waypoint. Most of the mission it's in the waiting state. That's where we can <a class="el" href="classcamera.html#a01b37a8f34e5b66cb84ff414c85cf8e9">start shooting a photo</a>, <a class="el" href="classlaser__range.html#aca0fade55156f20b299b4e25ebddcc28">request for laser range</a>, and calculate the <a class="el" href="classconverter.html">ECEF coordinates</a> of <a class="el" href="structdetection__result.html">detected objects</a></li>
</ul>
<div class="image">
<img src="service.jpg" alt=""/>
</div>
<p>The following diagram describes the state of the drone onboard service. The initial state is <code>ready</code>. In this state, the service emits <code>READY</code> for drone control until the user receives the input polygon, and the service <a class="el" href="classmission__builder.html">builds the mission path</a>. When the mission path is ready, the state is switched to a special state, <code>path_data</code>, which emits <code>PATH_DATA</code> and a message <code>mission_path</code>. Immediately after <code>PATH_DATA</code> is sent, the state is switched to the <code>path</code> state, emitting <code>PATH</code>. In this state, the user can cancel the mission or start it. Starting the mission is a two-step process. The first <code>init</code> step will fetch the mission path, switching to <code>forward_wait_start</code>, and the second <code>start</code> step will actually start the mission, switching to <code>forward_wait_update</code>.</p>
<p>In all the states except <code>forward_wait_update</code>, <code>backward_wait_update</code>, <code>forward_executing</code>, <code>backward_executing</code>, the update callbacks received from Payload SDK will be ignored. The <code>forward_wait_update/<code>backward_wait_update</code> will</code> be switched to <code>forward_executing/<code>backward_executing</code> once</code> the Payload SDK update is received. In these states <code>EXECUTING/PAUSED</code> emitted. All other states that were not mentioned so far will emit <code>WAITING</code>. In <code>forward_executing/backward_executing</code> states, the method <code>abort</code> can be called if a user wants to abort the mission (the following method will be <code>stop</code>), or the last fake waypoint reached, or the same mission but with the tweaked height need to be restarted (forward mission only, following method will be <code>start</code>). When the finish event is received from the Payload SDK callback, the state is switched to <code>forward_finished/backward_finished</code>. <code>set_backward</code> will switch the mission to <code>backward_wait_start</code> for the forward mission method. Another way to reach <code>backward_wait_start</code> is from <code>forward_wait_start</code> (when the last fake waypoint is reached and we want to start the backward mission). If no objects are detected in the forward mission, the method <code>stop</code> will move <code>backward_wait_start</code> to ready.</p>
<div class="image">
<img src="mission_state.jpg" alt=""/>
</div>
<dl class="section note"><dt>Note</dt><dd>C++, Linux </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
